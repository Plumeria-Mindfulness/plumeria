<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plumeria | Mensagem</title>

    <script defer src="minha-plumeria.js"></script>
    <script defer src="../js/funcoes.js"></script>

    <link rel="icon" href="../assets/plumeria-icon.png">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="mural.css">
    <link rel="stylesheet" href="minha-plumeria.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
</head>

<!--  -->
<body onload="validarSessao(), atualizarFeed()">

    <div class="div_backgroundBalls">
        <div class="div_Balls1"></div>
        <div class="div_BallsHeader1"></div>
        <div class="div_BallsHeader2"></div>
        <div class="div_BallsDown1"></div>
        <div class="div_BallsDown2"></div>
    </div>

    <div class="div_allAbove">
        <!-- Cabeçalho + Navbar -->
        <header class="header" id="header">
            <div class="container">
                <div class="logo" id="logo">
                    <a href="../index.html">
                        <img class="rotate" src="../assets/plumeria-icon.png" alt="icone de uma plumeria">
                        <span class="nome-logo">Plumeria</span>
                    </a> 
                </div>

                <div class="container-nav">
                    <nav class="navbar">
                      <div class="drop-down" onclick="alternarMenu()">
                        <img class="drop-down-ball-menu" src="../assets/drop-down-perfil/drop-down-ball-menu.svg">
                        <img class="drop-down-user-profile" src="../assets/drop-down-perfil/usuario-de-perfil.png">
                      </div>
                
                      <div class="sub-menu-wrap" id="subMenu">
                        <div class="sub-menu">
                          <div class="user-info">
                            <img src="../assets/drop-down-perfil/usuario-de-perfil.png" alt="icone usuario de perfil">
                            <!-- Adicionar um JS para pegar o nome que a pessoa cadastrou -->
                            <h3 id="nome"><span id="b_usuarioDropDown">usuário</span></h3>
                          </div>
                          <hr>
                
                          <a href="#" class="sub-menu-link">
                            <img src="../assets/drop-down-perfil/edit-user.png" alt="">
                            <p>Editar perfil</p>
                            <span>></span>
                          </a>
                
                          <a href="#" class="sub-menu-link">
                            <img src="../assets/drop-down-perfil/settings-profile.png" alt="">
                            <p>Configurações</p>
                            <span>></span>
                          </a>
                
                          <a href="dashboard.html" class="sub-menu-link">
                            <img src="../assets/drop-down-perfil/dashboard-especifico.png" alt="">
                            <p>Dashboard</p>
                            <span>></span>
                          </a>
                
                          <!-- Quando clicar no "Sair" será redirecionado para a página de login -->
                          <a href="../login.html" class="sub-menu-link" onclick="limparSessao()">
                            <img src="../assets/drop-down-perfil/log-out.png" alt="">
                            <p>Sair</p>
                            <span>></span>
                          </a>
                        </div>
                      </div>
                    </nav>
                </div>
            </div>
        </header>

        <div class="dash-right">
            <div class="avisos">
                <div class="container-mensagem-mural">
                    <div class="mensagem">
                        <div class="titulo-mensagem">
                            <h2 class="h2-dashboard">Publicar Mensagem</h2>
        
                            <p>
                                Escreva uma mensagem para si mesmo(a) falando um pouco de como foi sua experiência.
                            </p>
                        </div>
    
                        <div class="div-form">
                            <form class="form-postagem" id="form_postagem" method="post" onsubmit="return publicar()">
                                <input placeholder="Título" name="titulo" id="titulo" maxlength="100" type="text">
    
                                <br>
    
                                <textarea placeholder="Descrição (máximo de 1200 caracteres)" name="descricao" id="textarea_descricao" maxlength="1200" rows="10"></textarea>
                                
                                <br>
    
                                <div class="select-avaliacao">
                                    <p>
                                        Avalie como foi a experiência:
                                    </p>
    
                                    <select required name="avalicao" id="avaliacao">
                                        <option value="" disabled selected hidden>selecione uma opção</option>
                                        <option value="excelente">Excelente</option>
                                        <option value="muito bom">Muito bom</option>
                                        <option value="bom">Bom</option>
                                        <option value="ruim">Ruim</option>
                                        <option value="muito ruim">Muito ruim</option>
                                    </select>
                                </div>
                                
                                <button class="btn_passar">Enviar</button>
    
                                <div class="sigilo">
                                    <p>
                                        Essa mensagem é apenas para você! Prezamos pelo seu sigilo e não compartilhamos ou analisamos nenhuma informação.
                                    </p>
                                </div>
                            </form>
                        </div>
                    </div>
    
                    <div class="vertical-line"></div> 
    
                    <div class="mural">
                        <div class="titulo-mural">
                            <h2 class="h2-dashboard">Meu Mural</h2>
    
                            <p>
                                Aqui estão algumas lembranças das suas experiências.
                                <br>
                                Sinta-se a vontade para editar!
                            </p>
                        </div>
                        
                        <div class="div-results">
                            <div id="feed_container" class="feed-container">
                            </div>
                        </div>
                    </div>
    
                </div>
            </div>
            
            <!-- MODAL -->
            <!-- <div id="div_modal" class="div-modal">
                <div id="modal_backdrop" onclick="fecharModal()" class="modal-backdrop">
                </div>
                <div id="modal_container" class="modal-container">
                    <button class="btn-fechar-modal" onclick="fecharModal()">X</button>
                </div>
            </div> -->
            
            <!-- AGUARDAR -->
            <!-- <div id="div_aguardar" class="div-aguardar">
                <img src="./assets/aguarde-pink3.gif" id="img_aguarde">
            </div>  -->
        </div>
    </div>



</body>

</html>

<script>
    
    b_usuarioDropDown.innerHTML = sessionStorage.NOME_USUARIO;

    function limparFormulario() {
        document.getElementById("form_postagem").reset();
    }

    function publicar() {
        // Luiz => A variável abaixo pega o idUsuario do SessionStorage
        var idUsuario = sessionStorage.ID_USUARIO;

        var corpo = {
            titulo: form_postagem.titulo.value,
            descricao: form_postagem.descricao.value,
            avaliacao: form_postagem.avaliacao.value
            // Luiz => Aqui é um objeto JSON que pega o título e descricão lá dos inputs
        }

        // Luiz => O método 'fetch' busca informação de alguma rota, fazendo uma requisição a ela
        // Luiz => Ir no src/routes/avisos.js ; que está sendo utilizada dentro de app.js
        // Luiz => o caminho é: Função JS chama fetch -> app.js -> routes/avisos.js -> dentro do routes/avisos.js o 'router' chama função chamando outra função 'publicar' dentro do avisoController e que passará valores de 'req' e 'res' -> controllers/avisoController.js -> os valores da vaiável 'corpo' criada aqui, é passada pelo 'req' para a função 'publicar' dentro da controllers/avisoController.js, onde são criadas novas variáveis isoladas para cada valor que veio da 'req' -> Caso não estiver com nenhuma variável 'undefined', chamará a função publicar model/avisoModel.js, que é quando será passado os valores de 'titulo', 'descricao' e 'idUsuario' -> model/avisoModel.js -> dentro da model/avisoModel.js tem uma função publicar que fará um 'insert into' com os valores passados nos parâmetros da própria função -> ao final dessa função terá um 'return' executando a instrução dentro do 'database' e o valor dessa excucção do 'return' será armazenado no 'res' que será retornado para controller/avisoController.js -> dentro da controller/avisoController.js e após passar pelo 'avisoModel.publicar()' entrará no método '.then' que pegará o 'res' do return passado e caso der tudo certo eu vou chorar muito de alegria e aívio, senão irá cair no método '.catch' retornando o que houve de erro
        fetch(`/avisos/publicar/${idUsuario}`, {
            method: "post",
            headers: {
                "Content-Type": "application/json"
            },
            // Luiz => aqui fala para passar os valores que estão no objeto JSON 'corpo', declarado acima, para a requisição
            body: JSON.stringify(corpo)
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                window.alert("Post realizado com sucesso pelo usuario de ID: " + idUsuario + "!");
                window.location = "/dashboard/mural.html";
                limparFormulario();
                finalizarAguardar();
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            finalizarAguardar();
        });

        return false;

    }

    function editar(idAviso) {
        sessionStorage.ID_POSTAGEM_EDITANDO = idAviso;

        console.log("cliquei em editar - " + idAviso);
        window.alert("Você será redirecionado(a) à página de edição do aviso de id número: " + idAviso);

        window.location = "/dashboard/edicao-mensagem.html"
    }

    function atualizarFeed() {
        //aguardar();
        fetch("/avisos/listar").then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    var feed = document.getElementById("feed_container");
                    var mensagem = document.createElement("span");
                    mensagem.innerHTML = "Nenhum resultado encontrado."
                    feed.appendChild(mensagem);
                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    var feed = document.getElementById("feed_container");
                    feed.innerHTML = "";

                    for (let i = resposta.length - 1; i>= 0; i--) {
                        var publicacao = resposta[i];

                        // Deixar a primeira letra da avaliação, que veio do BD, maiúscula
                        var avaliacaoMaiuscula = publicacao.avaliacao.charAt(0).toUpperCase() + publicacao.avaliacao.slice(1)

                        // criando e manipulando elementos do HTML via JavaScript
                        var divPublicacao = document.createElement("div");
                        var spanID = document.createElement("span");
                        // Luiz => Achar uma forma de pegar a data da sessão
                        var dataAviso = document.createElement("span");
                        var spanTitulo = document.createElement("span");
                        var spanNome = document.createElement("span");
                        var divDescricao = document.createElement("div");
                        var spanAvaliacao = document.createElement("span");
                        var divButtons = document.createElement("div");
                        var btnEditar = document.createElement("button");


                        spanID.innerHTML = "ID: <b>" + publicacao.idAviso + "</b>";
                        // Luiz => Achar uma forma de pegar a data da sessão
                        dataAviso.innerHTML = "Data: <b> 19/11/2022 </b>";
                        spanTitulo.innerHTML = "Título: <b>" + publicacao.titulo + "</b>";
                        spanNome.innerHTML = "Autor: <b>" + publicacao.nome + "</b>";
                        divDescricao.innerHTML = "Descrição: <b>" + publicacao.descricao + "</b>";
                        spanAvaliacao.innerHTML = "Avaliação: <b>" + avaliacaoMaiuscula + "</b>";
                        btnEditar.innerHTML = "Editar";

                        divPublicacao.className = "publicacao";
                        spanTitulo.id = "inputNumero" + publicacao.idAviso;
                        spanNome.className = "publicacao-nome";
                        spanTitulo.className = "publicacao-titulo";
                        divDescricao.className = "publicacao-descricao";

                        divButtons.className = "div-buttons";

                        btnEditar.className = "publicacao-btn-editar";
                        btnEditar.id = "btnEditar" + publicacao.idAviso;
                        btnEditar.setAttribute("onclick", `editar(${publicacao.idAviso})`);

                        divPublicacao.appendChild(spanID);
                        // Luiz => Achar uma forma de pegar a data da sessão
                        divPublicacao.appendChild(dataAviso);
                        divPublicacao.appendChild(spanNome);
                        divPublicacao.appendChild(spanTitulo);
                        divPublicacao.appendChild(divDescricao);
                        divPublicacao.appendChild(spanAvaliacao);
                        divPublicacao.appendChild(divButtons);
                        divButtons.appendChild(btnEditar);
                        feed.appendChild(divPublicacao);
                    }

                    finalizarAguardar();
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
            finalizarAguardar();
        });
    }

    // function testar() {
    //     aguardar();

    //     var formulario = new URLSearchParams(new FormData(document.getElementById("form_postagem")));

    //     var divResultado = document.getElementById("div_feed");

    //     divResultado.appendChild(document.createTextNode(formulario.get("descricao")));
    //     divResultado.innerHTML = formulario.get("descricao");

    //     finalizarAguardar();

    //     return false;
    // }

</script>
